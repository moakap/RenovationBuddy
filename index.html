<!DOCTYPE html>
<html>
<head>
    <title>装修验收助手</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .hidden { display: none; }
        
        .check-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        
        .status-btn {
            padding: 5px 10px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pending { background-color: #ffd700; }
        .passed { background-color: #90EE90; }
        .failed { background-color: #ff6961; }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            margin: 20% auto;
            width: 80%;
        }
        
        .media-thumb {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .button-group {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button[type="button"] {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .loading::after {
            content: " ";
            display: inline-block;
            width: 1em;
            height: 1em;
            margin-left: 0.5em;
            vertical-align: middle;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #global-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            max-width: 80%;
            display: none;
            z-index: 1000;
        }

        .alert-error {
            background: #ffebee;
            color: #b71c1c;
            border: 1px solid #ffcdd2;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .alert-show {
            display: block;
            animation: slideIn 0.3s, fadeOut 3s 0.3s;
        }

        @keyframes slideIn {
            from { top: -50px; }
            to { top: 20px; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        #loading-screen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
    <div id="loading-screen" class="container">
        <div class="loader"></div>
        <p>正在验证登录状态...</p>
    </div>

    <div id="auth-section" class="container">
        <h1>装修验收助手</h1>
        <form id="auth-forms" onsubmit="return false;">
            <div class="form-group">
                <label for="email">电子邮箱：</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">密码：</label>
                <input type="password" id="password" required>
            </div>
            <div class="button-group">
                <button type="button" onclick="handleLogin()">登录</button>
                <button type="button" onclick="handleSignup()">注册</button>
            </div>
        </form>
    </div>

    <div id="main-app" class="container hidden">
        <div class="header">
            <h1>装修验收助手 <button onclick="logout()">登出</button></h1>
            <div class="add-form">
                <input type="text" id="item-name" placeholder="项目名称">
                <textarea id="item-desc" placeholder="项目描述"></textarea>
                <button onclick="addCheckItem()"><i class="fas fa-plus"></i> 添加验收项</button>
            </div>
        </div>

        <div id="checklist"></div>
        
        <div id="upload-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close" onclick="closeUpload()">&times;</span>
                <input type="file" id="file-input" accept="image/*,video/*">
                <button onclick="uploadMedia()">上传</button>
                <div id="preview"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>

    <script>
        // const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        // const SUPABASE_KEY = 'YOUR_SUPABASE_KEY';
        const SUPABASE_URL = 'https://ebcslqzdvqicnooeeljp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImViY3NscXpkdnFpY25vb2VlbGpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3Njc4NzYsImV4cCI6MjA1NzM0Mzg3Nn0.Z6n7UTkhzDEJYyeIzf5h89cmqon3upDeYvJE_xGW7PU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentItemId = null;
        
        // 
        // 新增全局提示方法
        function showAlert(message, type = 'error') {
            const alertEl = document.getElementById('global-alert');
            alertEl.className = `alert-${type} alert-show`;
            alertEl.textContent = message;
            
            setTimeout(() => {
                alertEl.classList.remove('alert-show');
            }, 3000);
        }

        // 身份验证处理
        async function handleLogin() {
            const btn = document.querySelector('#auth-forms button[onclick="handleLogin()"]');
            try {
                btn.classList.add('loading');
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                const { error } = await supabase.auth.signInWithPassword({ 
                    email, 
                    password 
                });

                if (error) throw error;
                
                showAlert('登录成功', 'success');
            } catch (error) {
                showAlert(`登录失败: ${error.message}`);
            } finally {
                btn.classList.remove('loading');
            }
        }
        
        async function handleSignup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabase.auth.signUp({ email, password });
            if (error) alert(error.message);
            else alert('确认邮件已发送，请验证后登录');
        }
        
        async function logout() {
            await supabase.auth.signOut();
        }
        
        // 加载验收项目
        async function loadChecklist() {
            const { data: items } = await supabase
                .from('check_items')
                .select('*')
                .eq('user_id', (await supabase.auth.getUser()).data.user.id);
            
            const checklist = document.getElementById('checklist');
            checklist.innerHTML = '';
            
            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'check-item';
                itemDiv.innerHTML = `
                    <h3>${item.name}</h3>
                    <p>${item.description}</p>
                    <button class="status-btn ${item.status}" 
                        onclick="updateStatus('${item.id}', '${item.status}')">
                        ${item.status}
                    </button>
                    <button onclick="showUpload('${item.id}')">上传媒体</button>
                    <div id="media-${item.id}"></div>
                `;
                checklist.appendChild(itemDiv);
                loadMedia(item.id);
            });
        }
        
        // 添加验收项目
        async function addCheckItem() {
            const btn = document.querySelector('button[onclick="addCheckItem()"]');
            try {
                btn.classList.add('loading');
                btn.disabled = true;

                const name = document.getElementById('item-name').value;
                const desc = document.getElementById('item-desc').value;
                
                if (!name.trim()) {
                    throw new Error('项目名称不能为空');
                }

                // 获取当前用户
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    showAlert('请先登录', 'error');
                    return;
                }

                const { error } = await supabase
                    .from('check_items')
                    .insert([{ 
                        name,
                        description: desc,
                        user_id: user.id,
                        status: 'pending'
                    }])
                    .select();

                if (error) throw error;
                
                showAlert('项目添加成功', 'success');
                loadChecklist();
                document.getElementById('item-name').value = '';
                document.getElementById('item-desc').value = '';
            } catch (error) {
                showAlert(`添加失败: ${error.message}`);
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }
        
        // 文件上传处理
        function showUpload(itemId) {
            currentItemId = itemId;
            document.getElementById('upload-modal').classList.remove('hidden');
        }
        
        async function uploadMedia() {
            const btn = document.querySelector('#upload-modal button');
            try {
                btn.classList.add('loading');
                btn.disabled = true;

                const file = document.getElementById('file-input').files[0];
                if (!file) {
                    throw new Error('请选择要上传的文件');
                }

                const filePath = `${supabase.auth.user().id}/${currentItemId}/${Date.now()}_${file.name}`;
                
                const { error: uploadError } = await supabase.storage
                    .from('project-media')
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                const { error: dbError } = await supabase
                    .from('media_files')
                    .insert([{
                        item_id: currentItemId,
                        url: filePath,
                        type: file.type.startsWith('image') ? 'image' : 'video'
                    }]);

                if (dbError) throw dbError;

                showAlert('文件上传成功', 'success');
                loadMedia(currentItemId);
                closeUpload();
            } catch (error) {
                showAlert(`上传失败: ${error.message}`);
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }
        
        // 加载媒体文件
        async function loadMedia(itemId) {
            const { data } = await supabase
                .from('media_files')
                .select('*')
                .eq('item_id', itemId);
            
            const mediaDiv = document.getElementById(`media-${itemId}`);
            mediaDiv.innerHTML = data.map(file => `
                ${file.type === 'image' ? 
                    `<img src="${SUPABASE_URL}/storage/v1/object/public/project-media/${file.url}" 
                          class="media-thumb">` :
                    `<video controls class="media-thumb">
                        <source src="${SUPABASE_URL}/storage/v1/object/public/project-media/${file.url}">
                     </video>`
                }
            `).join('');
        }
        
        // 初始化
        let authChecked = false;

        async function initApp() {
            // 显示加载状态
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');

            // 先尝试获取已有会话
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (session) {
                // 已有有效会话
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                loadChecklist();
            } else {
                // 无有效会话
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
            
            // 隐藏加载界面
            document.getElementById('loading-screen').classList.add('hidden');
            authChecked = true;
        }

        // 修改Auth状态监听
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (!authChecked) return; // 跳过初始化时的重复触发
            
            if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                if (event === 'SIGNED_IN') loadChecklist();
            } else if (event === 'SIGNED_OUT') {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
        });

        // 在页面加载时初始化
        document.addEventListener('DOMContentLoaded', initApp);

        async function updateStatus(itemId, currentStatus) {
            const statuses = ['pending', 'passed', 'failed'];
            const newStatus = statuses[(statuses.indexOf(currentStatus) + 1) % 3];
            
            try {
                const btn = document.querySelector(`button[onclick="updateStatus('${itemId}', '${currentStatus}')"]`);
                btn.classList.add('loading');
                btn.disabled = true;

                const { error } = await supabase
                    .from('check_items')
                    .update({ status: newStatus })
                    .eq('id', itemId);

                if (error) throw error;

                btn.className = `status-btn ${newStatus}`;
                btn.textContent = newStatus;
                btn.onclick = () => updateStatus(itemId, newStatus);
                
                showAlert('状态更新成功', 'success');
            } catch (error) {
                showAlert(`状态更新失败: ${error.message}`);
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }
    </script>

    <div id="global-alert"></div>

</body>
</html>
