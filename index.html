<!DOCTYPE html>
<html>
<head>
    <title>装修验收助手</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .hidden { display: none; }
        .check-item { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .status-btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
        .pending { background-color: #ffd700; }
        .passed { background-color: #90EE90; }
        .failed { background-color: #ff6961; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; padding: 20px; margin: 20% auto; width: 80%; }
        .loading { opacity: 0.7; pointer-events: none; }
        @keyframes fadeOut { 0% { opacity: 1; } 90% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="loading-screen" class="container hidden">正在验证登录状态...</div>
    
    <div id="auth-section" class="container">
        <h1>装修验收助手</h1>
        <form onsubmit="return false;">
            <input type="email" id="email" placeholder="电子邮箱" required>
            <input type="password" id="password" placeholder="密码" required>
            <button type="button" onclick="handleLogin()">登录</button>
            <button type="button" onclick="handleSignup()">注册</button>
        </form>
    </div>
    
    <div id="main-app" class="container hidden">
        <h1>装修验收助手 <button onclick="logout()">登出</button></h1>
        <input type="text" id="item-name" placeholder="项目名称">
        <textarea id="item-desc" placeholder="项目描述"></textarea>
        <button onclick="addCheckItem()">添加验收项</button>
        <div id="checklist"></div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://ebcslqzdvqicnooeeljp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImViY3NscXpkdnFpY25vb2VlbGpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3Njc4NzYsImV4cCI6MjA1NzM0Mzg3Nn0.Z6n7UTkhzDEJYyeIzf5h89cmqon3upDeYvJE_xGW7PU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        async function handleLogin() {
            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                loadChecklist();
            } catch (error) {
                alert(`登录失败: ${error.message}`);
            }
        }

        async function handleSignup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabase.auth.signUp({ email, password });
            if (error) alert(error.message);
            else alert('确认邮件已发送，请验证后登录');
        }
        
        async function logout() {
            await supabase.auth.signOut();
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        async function loadChecklist() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;
            const { data: items } = await supabase.from('check_items').select('*').eq('user_id', user.id);
            const checklist = document.getElementById('checklist');
            checklist.innerHTML = items.map(item => `
                <div class="check-item">
                    <h3>${item.name}</h3>
                    <p>${item.description}</p>
                    <button class="status-btn ${item.status}" onclick="updateStatus('${item.id}', '${item.status}')">${item.status}</button>
                </div>`).join('');
        }
        
        async function addCheckItem() {
            const name = document.getElementById('item-name').value;
            const desc = document.getElementById('item-desc').value;
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;
            const { error } = await supabase.from('check_items').insert([{ name, description: desc, user_id: user.id, status: 'pending' }]);
            if (!error) loadChecklist();
        }
        
        async function updateStatus(itemId, currentStatus) {
            const statuses = ['pending', 'passed', 'failed'];
            const newStatus = statuses[(statuses.indexOf(currentStatus) + 1) % 3];
            const { error } = await supabase.from('check_items').update({ status: newStatus }).eq('id', itemId);
            if (!error) loadChecklist();
        }
        
        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                loadChecklist();
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
