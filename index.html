<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è£…ä¿®éªŒæ”¶åŠ©æ‰‹</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .container { max-width: 500px; margin: auto; padding: 20px; }
        .hidden { display: none; }
        button { padding: 10px; margin: 10px; cursor: pointer; }
        ul { list-style-type: none; padding: 0; }
        li { padding: 10px; background: #f4f4f4; margin: 5px 0; cursor: pointer; }
    </style>
    
</head>
<body>
    <div class="container">
        <!-- æ³¨å†Œ & ç™»å½• -->
        <div id="auth-section">
            <h2>æ¬¢è¿ä½¿ç”¨è£…ä¿®éªŒæ”¶åŠ©æ‰‹</h2>
            <input type="email" id="email" placeholder="é‚®ç®±">
            <input type="password" id="password" placeholder="å¯†ç ">
            <button id="login-btn">ç™»å½•</button>
            <button id="signup-btn">æ³¨å†Œ</button>
        </div>

        <!-- éªŒæ”¶æ­¥éª¤åˆ—è¡¨ -->
        <div id="steps-section" class="hidden">
            <h2>éªŒæ”¶æ­¥éª¤</h2>
            <ul id="steps-list"></ul>
            <button id="add-step-btn">æ·»åŠ æ–°éªŒæ”¶æ­¥éª¤</button>
            <button id="view-results-btn">æŸ¥çœ‹éªŒæ”¶å†å²</button>
            <button id="logout-btn">é€€å‡º</button>
        </div>

        <!-- å½•å…¥éªŒæ”¶ç»“æœ -->
        <div id="verify-section" class="hidden">
            <h2>éªŒæ”¶æ­¥éª¤: <span id="step-name"></span></h2>
            <textarea id="step-result" placeholder="å¡«å†™éªŒæ”¶ç»“æœ..."></textarea>
            <input type="file" id="image-upload" accept="image/*,video/*">
            <button id="submit-btn">æäº¤éªŒæ”¶ç»“æœ</button>
            <button onclick="showSteps()">è¿”å›</button>
        </div>

        <!-- æŸ¥çœ‹éªŒæ”¶ç»“æœ -->
        <div id="results-section" class="hidden">
            <h2>éªŒæ”¶å†å²</h2>
            <ul id="result-list"></ul>
            <button onclick="showSteps()">è¿”å›</button>
        </div>
    </div>

    <!-- <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        const supabaseUrl = 'https://ebcslqzdvqicnooeeljp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImViY3NscXpkdnFpY25vb2VlbGpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3Njc4NzYsImV4cCI6MjA1NzM0Mzg3Nn0.Z6n7UTkhzDEJYyeIzf5h89cmqon3upDeYvJE_xGW7PU';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        let currentStepId = null;

        // ğŸ“Œ æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkUser() {
            const { data, error } = await supabase.auth.getUser();
            if (data.user) {
                showSteps();
            } else {
                showAuth();
            }
        }
        checkUser();

        // ğŸ“Œ æ˜¾ç¤ºç™»å½•/æ³¨å†Œç•Œé¢
        function showAuth() {
            document.getElementById("auth-section").classList.remove("hidden");
            document.getElementById("steps-section").classList.add("hidden");
            document.getElementById("verify-section").classList.add("hidden");
            document.getElementById("results-section").classList.add("hidden");
        }

        // ğŸ“Œ æ˜¾ç¤ºéªŒæ”¶æ­¥éª¤
        function showSteps() {
            document.getElementById("auth-section").classList.add("hidden");
            document.getElementById("steps-section").classList.remove("hidden");
            document.getElementById("verify-section").classList.add("hidden");
            document.getElementById("results-section").classList.add("hidden");
            fetchSteps();
        }

        // ğŸ“Œ æ˜¾ç¤ºéªŒæ”¶è¯¦æƒ…
        function showVerify(stepId, stepName) {
            currentStepId = stepId;
            document.getElementById("step-name").textContent = stepName;
            document.getElementById("steps-section").classList.add("hidden");
            document.getElementById("verify-section").classList.remove("hidden");
        }

        // ğŸ“Œ æ˜¾ç¤ºéªŒæ”¶å†å²
        function showResults() {
            document.getElementById("steps-section").classList.add("hidden");
            document.getElementById("results-section").classList.remove("hidden");
            fetchResults();
        }

        // ğŸ“Œ å¤„ç†ç”¨æˆ·æ³¨å†Œ
        document.getElementById("signup-btn").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            await supabase.auth.signUp({ email, password });
            alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
        });

        // ğŸ“Œ å¤„ç†ç”¨æˆ·ç™»å½•
        document.getElementById("login-btn").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) alert("ç™»å½•å¤±è´¥ï¼š" + error.message);
            else showSteps();
        });

        // ğŸ“Œ è·å–éªŒæ”¶æ­¥éª¤
        async function fetchSteps() {
            const { data, error } = await supabase.from("steps").select("*");
            if (error) return;
            const stepsList = document.getElementById("steps-list");
            stepsList.innerHTML = "";
            data.forEach(step => {
                const li = document.createElement("li");
                li.textContent = step.name;
                li.onclick = () => showVerify(step.id, step.name);
                stepsList.appendChild(li);
            });
        }

        // ğŸ“Œ æ·»åŠ éªŒæ”¶æ­¥éª¤
        document.getElementById("add-step-btn").addEventListener("click", async () => {
            const name = prompt("è¯·è¾“å…¥æ–°çš„éªŒæ”¶æ­¥éª¤åç§°");
            if (!name) return;
            await supabase.from("steps").insert([{ name }]);
            fetchSteps();
        });

        // ğŸ“Œ æäº¤éªŒæ”¶ç»“æœ
        document.getElementById("submit-btn").addEventListener("click", async () => {
            const resultText = document.getElementById("step-result").value;
            const file = document.getElementById("image-upload").files[0];
            let mediaUrl = "";

            if (file) {
                const { data, error } = await supabase.storage.from('uploads').upload(`uploads/${file.name}`, file);
                if (!error) mediaUrl = `${supabaseUrl}/storage/v1/object/public/uploads/${data.path}`;
            }

            await supabase.from("results").insert([{ step_id: currentStepId, result: resultText, media_url: mediaUrl }]);
            alert("æäº¤æˆåŠŸï¼");
            showSteps();
        });

        // ğŸ“Œ è·å–éªŒæ”¶å†å²
        async function fetchResults() {
            const { data, error } = await supabase.from("results").select("*");
            if (error) return;
            const resultList = document.getElementById("result-list");
            resultList.innerHTML = "";
            data.forEach(result => {
                const li = document.createElement("li");
                li.innerHTML = `<p>${result.result}</p>${result.media_url ? `<img src="${result.media_url}" width="100">` : ""}`;
                resultList.appendChild(li);
            });
        }

        // ğŸ“Œ é€€å‡ºç™»å½•
        document.getElementById("logout-btn").addEventListener("click", async () => {
            await supabase.auth.signOut();
            showAuth();
        });
    </script>
</body>
</html>
